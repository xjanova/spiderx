name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          configuration: ".github/changelog-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: SpiderX ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workload
        run: dotnet workload install maui-windows

      - name: Restore
        run: dotnet restore

      - name: Publish Windows x64
        run: |
          dotnet publish src/SpiderX.App/SpiderX.App.csproj `
            -c Release `
            -f net8.0-windows10.0.19041.0 `
            -r win-x64 `
            -p:PublishSingleFile=true `
            -p:SelfContained=true `
            -p:Version=${{ needs.create-release.outputs.version }} `
            -o ./publish/windows-x64

      - name: Create ZIP
        run: Compress-Archive -Path ./publish/windows-x64/* -DestinationPath ./SpiderX-${{ needs.create-release.outputs.version }}-windows-x64.zip

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: SpiderX-${{ needs.create-release.outputs.version }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore
        run: dotnet restore

      - name: Publish macOS
        run: |
          dotnet publish src/SpiderX.App/SpiderX.App.csproj \
            -c Release \
            -f net8.0-maccatalyst \
            -p:Version=${{ needs.create-release.outputs.version }} \
            -o ./publish/macos

      - name: Create ZIP
        run: |
          cd ./publish/macos
          zip -r ../../SpiderX-${{ needs.create-release.outputs.version }}-macos.zip .

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: SpiderX-${{ needs.create-release.outputs.version }}-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Install MAUI workload
        run: dotnet workload install maui-android

      - name: Restore
        run: dotnet restore

      - name: Publish Android APK
        run: |
          dotnet publish src/SpiderX.App/SpiderX.App.csproj \
            -c Release \
            -f net8.0-android \
            -p:AndroidPackageFormat=apk \
            -p:Version=${{ needs.create-release.outputs.version }} \
            -o ./publish/android

      - name: Rename APK
        run: |
          mv ./publish/android/*.apk ./SpiderX-${{ needs.create-release.outputs.version }}-android.apk

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: SpiderX-${{ needs.create-release.outputs.version }}-android.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-nuget:
    name: Publish NuGet Packages
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore

      - name: Pack
        run: |
          dotnet pack src/SpiderX.Crypto/SpiderX.Crypto.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Transport/SpiderX.Transport.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Core/SpiderX.Core.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Services/SpiderX.Services.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg

      - name: Push to NuGet
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        continue-on-error: true

      - name: Push to GitHub Packages
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate
