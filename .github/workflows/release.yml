name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/version-bump.yml'
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Triggered by tag push
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: $TAG_NAME"
          else
            # Triggered by merge to main - auto bump patch version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Latest tag: $LATEST_TAG"

            # Extract version parts
            VERSION_PART=${LATEST_TAG#v}
            IFS='.-' read -r MAJOR MINOR PATCH PRE <<< "$VERSION_PART"
            MAJOR=${MAJOR:-0}
            MINOR=${MINOR:-0}
            PATCH=${PATCH:-0}

            # Auto bump patch version
            PATCH=$((PATCH + 1))
            VERSION="$MAJOR.$MINOR.$PATCH"
            TAG_NAME="v$VERSION"

            echo "Auto-generated version: $VERSION"
            echo "Creating tag: $TAG_NAME"

            # Create and push new tag
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME (auto-generated)"
            git push origin "$TAG_NAME"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          configuration: ".github/changelog-config.json"
          toTag: ${{ steps.get_version.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: SpiderX ${{ steps.get_version.outputs.tag_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workload
        run: dotnet workload install maui-windows

      - name: Restore
        run: dotnet restore

      - name: Publish Windows x64
        run: |
          dotnet publish src/SpiderX.App/SpiderX.App.csproj `
            -c Release `
            -f net9.0-windows10.0.19041.0 `
            -r win-x64 `
            -p:PublishSingleFile=true `
            -p:SelfContained=true `
            -p:Version=${{ needs.create-release.outputs.version }} `
            -o ./publish/windows-x64

      - name: Create ZIP
        run: Compress-Archive -Path ./publish/windows-x64/* -DestinationPath ./SpiderX-${{ needs.create-release.outputs.version }}-windows-x64.zip

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: SpiderX-${{ needs.create-release.outputs.version }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-nuget:
    name: Publish NuGet Packages
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Pack
        run: |
          dotnet pack src/SpiderX.Crypto/SpiderX.Crypto.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Transport/SpiderX.Transport.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Core/SpiderX.Core.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg
          dotnet pack src/SpiderX.Services/SpiderX.Services.csproj -c Release -p:PackageVersion=${{ needs.create-release.outputs.version }} -o ./nupkg

      - name: Push to NuGet
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        continue-on-error: true

      - name: Push to GitHub Packages
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate
