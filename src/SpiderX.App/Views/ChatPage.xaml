<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SpiderX.App.ViewModels"
             x:Class="SpiderX.App.Views.ChatPage"
             x:DataType="vm:ChatViewModel"
             Title="{Binding PeerName}">

    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#0A0A1A" Offset="0.0" />
            <GradientStop Color="#0A1020" Offset="0.5" />
            <GradientStop Color="#10102A" Offset="1.0" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Call" Command="{Binding StartCallCommand}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header with Status -->
        <Border Grid.Row="0" Padding="16" StrokeThickness="0" Margin="0">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                    <GradientStop Color="#1A1030" Offset="0.0" />
                    <GradientStop Color="#102030" Offset="1.0" />
                </LinearGradientBrush>
            </Border.Background>
            <HorizontalStackLayout Spacing="10">
                <Border WidthRequest="14" HeightRequest="14" StrokeThickness="0" IsVisible="{Binding IsOnline}">
                    <Border.Background>
                        <SolidColorBrush Color="#22C55E" />
                    </Border.Background>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="7" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#22C55E" Offset="0,0" Radius="6" Opacity="0.8" />
                    </Border.Shadow>
                </Border>
                <Label Text="{Binding IsOnline, Converter={StaticResource OnlineStatusConverter}}" TextColor="#94A3B8" FontSize="13" VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Border>

        <!-- Messages -->
        <CollectionView Grid.Row="1" ItemsSource="{Binding Messages}" ItemsUpdatingScrollMode="KeepLastItemInView" BackgroundColor="Transparent">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:MessageItem">
                    <Grid Padding="16,6">
                        <!-- Outgoing message (right aligned) -->
                        <Border HorizontalOptions="End" MaximumWidthRequest="300" StrokeThickness="0" Padding="14,10" IsVisible="{Binding IsOutgoing}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#7C3AED" Offset="0.0" />
                                    <GradientStop Color="#EC4899" Offset="1.0" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="18,18,4,18" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="#7C3AED" Offset="0,3" Radius="10" Opacity="0.3" />
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="6">
                                <Label Text="{Binding Content}" TextColor="White" FontSize="15" />
                                <HorizontalStackLayout Spacing="6" HorizontalOptions="End">
                                    <Label Text="{Binding TimeText}" TextColor="White" FontSize="11" Opacity="0.7" />
                                    <Label Text="{Binding Status}" TextColor="White" FontSize="11" Opacity="0.7" IsVisible="{Binding Status, Converter={StaticResource StringToBoolConverter}}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Incoming message (left aligned) -->
                        <Border HorizontalOptions="Start" MaximumWidthRequest="300" StrokeThickness="1" Stroke="#2A2A4A" BackgroundColor="#161630" Padding="14,10"
                                IsVisible="{Binding IsOutgoing, Converter={StaticResource InvertBoolConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="18,18,18,4" />
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="6">
                                <Label Text="{Binding Content}" TextColor="#F8FAFC" FontSize="15" />
                                <Label Text="{Binding TimeText}" TextColor="#64748B" FontSize="11" HorizontalOptions="End" />
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <Border Padding="40" BackgroundColor="#12121F" StrokeThickness="1" Stroke="#2A2A4A" Margin="16,40">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                        <Border WidthRequest="70" HeightRequest="70" StrokeThickness="0" HorizontalOptions="Center">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#1A2A4A" Offset="0.0" />
                                    <GradientStop Color="#2A1A4A" Offset="1.0" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="20" />
                            </Border.StrokeShape>
                            <Label Text="ðŸ’¬" FontSize="32" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <Label Text="No messages yet" FontSize="16" FontAttributes="Bold" TextColor="#F8FAFC" HorizontalTextAlignment="Center" />
                        <Label Text="Say hello!" FontSize="14" TextColor="#64748B" HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </Border>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Input area -->
        <Border Grid.Row="2" Padding="12" StrokeThickness="0">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                    <GradientStop Color="#1A1030" Offset="0.0" />
                    <GradientStop Color="#101A30" Offset="1.0" />
                </LinearGradientBrush>
            </Border.Background>
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                <!-- Attach file button -->
                <Border WidthRequest="46" HeightRequest="46" StrokeThickness="1" Stroke="#3A3A5A" BackgroundColor="#1A1A2E">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="14" />
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SendFileCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="ðŸ“Ž" FontSize="20" HorizontalOptions="Center" VerticalOptions="Center" />
                </Border>

                <!-- Text input -->
                <Border Grid.Column="1" StrokeThickness="1" Stroke="#3A2A5A" BackgroundColor="#15102A" Padding="14,0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="22" />
                    </Border.StrokeShape>
                    <Entry Text="{Binding MessageText}" Placeholder="Type a message..." PlaceholderColor="#64748B" TextColor="#F8FAFC" BackgroundColor="Transparent" ReturnType="Send" ReturnCommand="{Binding SendMessageCommand}" VerticalOptions="Center" />
                </Border>

                <!-- Send button -->
                <Border Grid.Column="2" WidthRequest="46" HeightRequest="46" StrokeThickness="0">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#7C3AED" Offset="0.0" />
                            <GradientStop Color="#EC4899" Offset="1.0" />
                        </LinearGradientBrush>
                    </Border.Background>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="14" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#7C3AED" Offset="0,3" Radius="8" Opacity="0.4" />
                    </Border.Shadow>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SendMessageCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="âž¤" FontSize="20" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                </Border>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
